<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financiero (BOB) - Google Sheets</title>
    <!-- Carga de Tailwind CSS CDN para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente principal */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background-color: #f9fafb; }
        /* Animación de spin para el loader */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
    <!-- Configuración de la fuente Inter para Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body>
    <div id="app-container" class="min-h-screen bg-gray-50 p-4 sm:p-8 font-inter">
        <!-- El contenido de la aplicación será inyectado aquí por JavaScript -->
        <div class="max-w-4xl mx-auto text-center p-12">
            <h1 class="text-2xl font-bold text-gray-400">Cargando aplicación...</h1>
        </div>
    </div>

    <script type="text/javascript">
        // =================================================================
        // 1. CONFIGURACIÓN DE GOOGLE SHEETS API
        // =================================================================
        const CLIENT_ID = '648609927639-3sgu9lt0i47flhdv6nb3cck08o49h4tl.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1eFX-xRPMeuZVKc9PSLED6_XakyVqSOt6kO4zA-xUZY8';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const RANGE = 'Hoja1!A2:D';

        // =================================================================
        // 2. ESTADO GLOBAL (Reemplaza a useState de React)
        // =================================================================
        let appState = {
            isAuthorized: false,
            isLoading: true,
            isApiLoading: false,
            error: null,
            expenses: [],
            today: new Date().toISOString().split('T')[0],
        };

        const appContainer = document.getElementById('app-container');

        // =================================================================
        // 3. UTILIDADES Y FORMATO
        // =================================================================

        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-BO', {
                style: 'currency',
                currency: 'BOB',
                minimumFractionDigits: 2,
            }).format(value);
        };
        
        // Simulación de íconos Lucide con SVG inline
        const iconSvg = (name, classes = '', size = 24) => {
            const icons = {
                'DollarSign': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
                'BarChart2': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>`,
                'PlusCircle': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`,
                'Calendar': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>`,
                'Loader': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M12 2v4"/><path d="m16.2 7.8 2.5-2.5"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.5 2.5"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.5 2.5"/><path d="M2 12h4"/><path d="m7.8 7.8-2.5-2.5"/></svg>`,
                'LogIn': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>`,
                'LogOut': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>`,
                'LinkIcon': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.74 1.74"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>`,
                'AlertTriangle': `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m21.73 18-9-15-9 15z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
            };
            return icons[name] || '';
        };

        // =================================================================
        // 4. FUNCIONES DE GOOGLE API
        // =================================================================
        
        const updateSignInStatus = (isSignedIn) => {
            appState.isAuthorized = isSignedIn;
            if (isSignedIn) {
                listExpenses();
            } else {
                appState.expenses = [];
                appState.isLoading = false;
                render();
            }
        };

        const initClient = () => {
            window.gapi.client.init({
                clientId: CLIENT_ID,
                scope: SCOPES,
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
            }).then(() => {
                // Éxito en la inicialización
                appState.isApiLoading = false;
                window.gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
                updateSignInStatus(window.gapi.auth2.getAuthInstance().isSignedIn.get());
            }, (error) => {
                appState.error = `Error al inicializar GAPI: ${error.details || 'Verifique la configuración.'}`;
                appState.isLoading = false;
                appState.isApiLoading = false;
                render();
            });
        };

        const handleClientLoad = () => {
            if (window.gapi) {
                window.gapi.load('client:auth2', initClient);
            } else {
                appState.error = 'Error de carga: El objeto gapi no se cargó correctamente.';
                appState.isLoading = false;
                appState.isApiLoading = false;
                render();
            }
        };

        const handleAuthClick = () => {
            if (window.gapi && window.gapi.auth2 && window.gapi.auth2.getAuthInstance()) {
                window.gapi.auth2.getAuthInstance().signIn();
            } else {
                appState.error = 'Error: La autenticación de Google no está lista. Intente recargar.';
                render();
            }
        };

        const handleSignoutClick = () => {
            if (window.gapi && window.gapi.auth2 && window.gapi.auth2.getAuthInstance()) {
                window.gapi.auth2.getAuthInstance().signOut();
            }
        };

        const listExpenses = async () => {
            appState.isLoading = true;
            appState.error = null;
            render();
            
            try {
                const response = await window.gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                });

                const records = response.result.values || [];
                appState.expenses = records.map((row, index) => {
                    const id = index + 2; 
                    const amountString = row[2] ? String(row[2]).replace(',', '.') : '0';
                    const amount = parseFloat(amountString);
                    
                    return {
                        id: id, 
                        date: row[0] || 'N/A', 
                        description: row[1] || 'Sin descripción', 
                        amount: isNaN(amount) ? 0 : amount, 
                        type: row[3] || 'Gasto'
                    };
                });

            } catch (err) {
                const message = err.result && err.result.error && err.result.error.message ? err.result.error.message : 'Error desconocido al leer la hoja.';
                appState.error = `Error al leer la hoja: ${message}. Asegúrese de que el ID de la hoja sea correcto y tenga permisos.`;
            } finally {
                appState.isLoading = false;
                render();
            }
        };

        const appendExpense = async (newExpense) => {
            appState.error = null;
            appState.isLoading = true;
            render();

            try {
                const amountToSend = newExpense.amount; 
                const rowData = [
                    newExpense.date,
                    newExpense.description,
                    amountToSend,
                    newExpense.type
                ];

                await window.gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Hoja1!A:D',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [rowData],
                    },
                });

                // Recargar la lista para reflejar el nuevo registro
                await listExpenses(); 
            } catch (err) {
                const message = err.result && err.result.error && err.result.error.message ? err.result.error.message : 'Error desconocido al escribir en la hoja.';
                appState.error = `Error al escribir en la hoja: ${message}.`;
                appState.isLoading = false;
                render();
            }
        };


        // =================================================================
        // 5. RENDERING (Construcción del HTML)
        // =================================================================

        const calculateSummary = () => {
            let totalIncome = 0;
            let totalExpenses = 0;

            appState.expenses.forEach(e => {
                const amount = parseFloat(e.amount); 
                if (!isNaN(amount)) {
                    if (e.type.toLowerCase() === 'ingreso') {
                        totalIncome += amount;
                    } else {
                        totalExpenses += amount;
                    }
                }
            });

            return { totalIncome, totalExpenses, netBalance: totalIncome - totalExpenses };
        };

        const renderSummaryCard = (title, value, color, iconName) => {
            const balanceColor = title === 'Saldo Neto' ? (value >= 0 ? 'blue' : 'red') : color;
            return `
                <div class="flex flex-col items-start p-4 bg-white rounded-xl shadow-lg border-b-4 border-${balanceColor}-500 transition-all duration-300 hover:shadow-xl">
                    ${iconSvg(iconName, `text-${balanceColor}-600 mb-2`, 28)}
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-bold text-${balanceColor}-700">${formatCurrency(value)}</p>
                </div>
            `;
        };
        
        const renderExpenseItem = (expense) => {
            const isIncome = expense.type.toLowerCase() === 'ingreso';
            const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
            const indicatorColor = isIncome ? 'border-green-500' : 'border-red-500';
            const sign = isIncome ? '+' : '-';

            // Nota: Los botones de edición/eliminación están deshabilitados en esta versión
            // de JavaScript/HTML simple que utiliza append en Google Sheets.
            return `
                <div class="flex items-center justify-between p-4 bg-white border-l-4 ${indicatorColor} rounded-lg shadow-sm mb-3 transition-all duration-300 hover:shadow-md">
                    <div class="flex flex-col sm:flex-row sm:items-center w-full">
                        <div class="flex-grow">
                            <p class="text-xs text-gray-500 flex items-center mb-1 sm:mb-0">
                                ${iconSvg('Calendar', 'mr-1', 12)}
                                ${expense.date}
                            </p>
                            <span class="text-lg font-medium text-gray-800">${expense.description}</span>
                        </div>
                        <div class="text-right mt-2 sm:mt-0 sm:w-1/3">
                            <p class="font-bold text-xl ${amountColor}">
                                ${sign} ${formatCurrency(Math.abs(expense.amount))}
                            </p>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${isIncome ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${expense.type}
                            </span>
                        </div>
                    </div>
                    <!-- Botones deshabilitados -->
                    <div class="flex space-x-2 ml-4">
                        <button class="text-gray-300 p-1 rounded-full cursor-not-allowed" disabled title="Edición no disponible">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                        </button>
                        <button class="text-gray-300 p-1 rounded-full cursor-not-allowed" disabled title="Eliminación no disponible">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `;
        };

        const render = () => {
            const { isAuthorized, isLoading, isApiLoading, error, expenses } = appState;
            const { totalIncome, totalExpenses, netBalance } = calculateSummary();

            let htmlContent = `
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-4 flex items-center justify-center">
                        ${iconSvg('BarChart2', 'mr-3 text-blue-500', 30)}
                        Gestor Financiero (BOB)
                    </h1>
                    <div class="text-center text-xs text-gray-500 mb-6 flex justify-center items-center">
                        ${iconSvg('LinkIcon', 'mr-1', 12)}
                        Conectado a Google Sheet: 
                        <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline ml-1 truncate max-w-[200px] sm:max-w-none">
                            Hoja de Cálculo
                        </a>
                    </div>
            `;

            // Panel de Autenticación
            htmlContent += `<div class="flex justify-center mb-6">`;
            if (!isAuthorized) {
                const disabled = isApiLoading || isLoading;
                const loaderHtml = (isApiLoading || isLoading) ? `<span class="mr-2 animate-spin">${iconSvg('Loader', '', 20)}</span>` : '';
                const logInIcon = (isApiLoading || isLoading) ? '' : `${iconSvg('LogIn', 'mr-2', 20)}`;

                htmlContent += `
                    <button id="auth-button" class="bg-blue-600 text-white p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 flex items-center ${disabled ? 'opacity-50 cursor-not-allowed' : ''}" ${disabled ? 'disabled' : ''}>
                        ${loaderHtml}
                        ${logInIcon}
                        Conectar con Google Sheets
                    </button>
                `;
            } else {
                htmlContent += `
                    <div class="flex space-x-4 items-center">
                        <p class="text-sm font-medium text-green-600 flex items-center">
                            Conexión exitosa. Datos de la Hoja.
                        </p>
                        <button id="signout-button" class="bg-gray-400 text-white p-2 rounded-lg shadow-md hover:bg-gray-500 transition duration-150 flex items-center">
                            ${iconSvg('LogOut', 'mr-1', 20)}
                            Desconectar
                        </button>
                    </div>
                `;
            }
            htmlContent += `</div>`;


            // Mensaje de Error/Carga
            if (error) {
                htmlContent += `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 flex items-start">
                        ${iconSvg('AlertTriangle', 'mt-1 mr-2 flex-shrink-0', 20)}
                        <span class="block sm:inline">${error}</span>
                    </div>
                `;
            }
            
            if (isApiLoading && !error) {
                htmlContent += `
                    <div class="text-center p-8 text-blue-500 flex justify-center items-center">
                        ${iconSvg('Loader', 'animate-spin mr-2', 24)}
                        Cargando librerías de Google API...
                    </div>
                `;
            } else if (isLoading && !error && isAuthorized) {
                htmlContent += `
                    <div class="text-center p-8 text-gray-500 flex justify-center items-center">
                        ${iconSvg('Loader', 'animate-spin mr-2', 24)}
                        Cargando datos de Google Sheets...
                    </div>
                `;
            }


            // Resumen Financiero
            if (isAuthorized && !isLoading) {
                htmlContent += `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        ${renderSummaryCard("Ingreso Total", totalIncome, "green", "DollarSign")}
                        ${renderSummaryCard("Gasto Total", totalExpenses, "red", "BarChart2")}
                        ${renderSummaryCard("Saldo Neto", netBalance, netBalance >= 0 ? 'blue' : 'red', "DollarSign")}
                    </div>
                `;

                // Formulario para añadir registros
                htmlContent += `
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Añadir Nuevo Registro</h2>
                        <form id="expense-form" class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                                <select id="type-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
                                    <option value="Gasto">Gasto</option>
                                    <option value="Ingreso">Ingreso</option>
                                </select>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto (BOB)</label>
                                <input type="number" step="0.01" min="0.01" id="amount-input" placeholder="0.00" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150" required />
                            </div>
                            <div class="col-span-4 md:col-span-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                                <input type="text" id="description-input" placeholder="Ej. Cena con amigos" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150" required />
                            </div>
                            <div class="col-span-4 md:col-span-1">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="date-input" value="${appState.today}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150" required />
                            </div>
                            <div class="col-span-4 md:col-span-1 flex items-end">
                                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 flex items-center justify-center" title="Añadir registro">
                                    ${iconSvg('PlusCircle', 'mr-1', 24)}
                                    Añadir
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                // Lista de registros
                htmlContent += `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Historial de Registros</h2>
                        <div class="space-y-3">
                `;
                if (expenses.length > 0) {
                    // Ordenar por fecha (descendente) y luego por ID (fila)
                    const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    htmlContent += sortedExpenses.map(renderExpenseItem).join('');
                } else {
                    htmlContent += `
                        <p class="text-center text-gray-500 p-4 border border-dashed border-gray-300 rounded-lg">
                            No hay registros aún en tu hoja de Google. ¡Añade tu primer gasto o ingreso!
                        </p>
                    `;
                }
                htmlContent += `
                        </div>
                    </div>
                `;
            }

            htmlContent += `</div>`;
            appContainer.innerHTML = htmlContent;

            // 6. ADJUNTO DE LISTENERS DESPUÉS DEL RENDERING
            if (!isAuthorized) {
                const authButton = document.getElementById('auth-button');
                if (authButton) {
                    authButton.onclick = handleAuthClick;
                }
            } else {
                const signoutButton = document.getElementById('signout-button');
                if (signoutButton) {
                    signoutButton.onclick = handleSignoutClick;
                }

                const expenseForm = document.getElementById('expense-form');
                if (expenseForm) {
                    expenseForm.onsubmit = handleAddExpense;
                }
            }
        };
        
        const handleAddExpense = (e) => {
            e.preventDefault();
            
            const descriptionInput = document.getElementById('description-input');
            const amountInput = document.getElementById('amount-input');
            const dateInput = document.getElementById('date-input');
            const typeSelect = document.getElementById('type-select');

            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;
            const type = typeSelect.value;

            if (description === '' || isNaN(amount) || amount <= 0) {
                appState.error = "Por favor, introduce una descripción y un monto válido.";
                render();
                return;
            }
            
            const newExpense = { date, description, amount, type };
            appendExpense(newExpense).then(() => {
                // Limpiar formulario después de añadir
                descriptionInput.value = '';
                amountInput.value = '';
                dateInput.value = appState.today;
                typeSelect.value = 'Gasto';
            });
        };


        // =================================================================
        // 7. INICIO DE LA APLICACIÓN
        // =================================================================

        const initApp = () => {
            // Cargar la librería de Google API
            if (typeof window.gapi === 'undefined') {
                appState.isApiLoading = true;
                render();
                const script = document.createElement('script');
                script.src = "https://apis.google.com/js/api.js";
                script.async = true; 
                script.onload = handleClientLoad;
                
                script.onerror = () => {
                    appState.error = 'Error crítico: Falló la carga de la librería de Google API.';
                    appState.isLoading = false;
                    appState.isApiLoading = false;
                    render();
                };
                document.body.appendChild(script);
            } else {
                handleClientLoad();
            }
        };

        window.onload = initApp;

    </script>
</body>
</html>
